---
import type { GetStaticPaths } from "astro";
import Pagination from "@/components/control/Pagination.astro";
import PostPage from "@/components/PostPage.astro";
import { PAGE_SIZE } from "@/constants/constants";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { getCollection } from 'astro:content';

export const getStaticPaths = (async ({ paginate }) => {
    // 获取所有文章
    const allPosts = await getCollection('posts');
    
    // 筛选加密货币相关文章
    const cryptoPosts = allPosts.filter(post => {
        // 按分类筛选
        if (post.data.category === 'crypto') return true;
        
        // 按标签筛选（可自行扩展）
        const cryptoKeywords = ['crypto', 'bitcoin', 'ethereum', 'blockchain', 'defi', '交易所','Bitget'];
        const tags = post.data.tags || [];
        const title = (post.data.title || '').toLowerCase();
        
        return cryptoKeywords.some(keyword => {
            const keywordLower = keyword.toLowerCase();
            return title.includes(keywordLower) ||
                   tags.some(tag => String(tag).toLowerCase().includes(keywordLower));
        });
    });
    
    // ⬇️ 修改这里的排序逻辑 ⬇️
    const sortedPosts = [...cryptoPosts].sort((a, b) => {
        // 1. 获取置顶状态，如果没有设置默认当做 false
        const aPinned = a.data.isPinned || false;
        const bPinned = b.data.isPinned || false;

        // 2. 如果只有其中一个是置顶，置顶的排在前面 (-1 表示前移，1 表示后移)
        if (aPinned && !bPinned) return -1;
        if (!aPinned && bPinned) return 1;

        // 3. 如果状态相同（都是置顶，或者都不是置顶），则按发布时间倒序排序（最新的在前）
        return new Date(b.data.published).getTime() - new Date(a.data.published).getTime();
    });
    // ⬆️ 修改结束 ⬆️
    
    // 返回分页路径
    return paginate(sortedPosts, { pageSize: PAGE_SIZE });
}) satisfies GetStaticPaths;

// 从props中获取当前页面的分页数据
const { page } = Astro.props;

// 显示标签（可自行修改添加）
const DISPLAY_TAGS = ['比特币', '以太坊', '区块链', 'DeFi', '交易所'];
---

<MainGridLayout title={'加密货币'}>
    <!-- 专栏标题区域 -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">加密货币专栏</h1>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
            区块链技术、数字货币分析与工具教程
        </p>
        
    </div>
    
    <!-- 文章内容区域 -->
    {page?.data?.length > 0 ? (
        <>
            <!-- 文章列表 -->
            <PostPage page={page}></PostPage>
            
            <!-- 分页组件 -->
            <Pagination 
                class="mx-auto onload-animation" 
                page={page}
            ></Pagination>
        </>
    ) : (
        <!-- 无文章时的提示 -->
        <div class="text-center py-16">
            <h2 class="text-xl font-semibold mb-3 text-gray-700 dark:text-gray-300">
                暂无加密货币相关文章
            </h2>
            <p class="text-gray-500 dark:text-gray-400 mb-6">
                当前检索标签：{DISPLAY_TAGS.join('、')}
            </p>
        </div>
    )}
</MainGridLayout>